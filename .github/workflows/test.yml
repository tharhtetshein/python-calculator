# CI/CD Workflow for Python Calculator
# This workflow runs linting, testing across multiple scenarios and platforms,
# and conditionally deploys to production
name: CI/CD Pipeline

# Trigger on push and pull requests to main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allow manual workflow runs from Actions tab
  workflow_dispatch:

# Cancel in-progress runs of the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
      # Checkout repository code - pinned to specific commit for security
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      # Setup Python environment
      - name: Set up Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
        with:
          python-version: '3.11'
          # Cache pip dependencies for faster builds
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      # Install linting tool
      - name: Install flake8
        run: pip install flake8
      
      # Run linter with configured rules
      - name: Run linter
        run: flake8 calculator.py test_calculator.py --max-line-length=100
      
      # Debug information (only shown when debug mode is enabled)
      - name: Debug information
        if: runner.debug == '1'
        run: |
          echo "Runner OS: ${{ runner.os }}"
          echo "Python version: 3.11"
          python --version
          pip list
  
  test-scenarios:
    name: Test ${{ matrix.scenario.name }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        scenario:
          - name: 'basic-operations'
            marker: 'not slow'
          - name: 'edge-cases'
            marker: 'edge'
          - name: 'performance'
            marker: 'slow'
    
    steps:
      # Checkout repository code - pinned to specific commit for security
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      # Setup Python with dependency caching
      - name: Set up Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      # Install test dependencies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-benchmark
      
      # Run scenario-specific tests with verbose output
      - name: Run ${{ matrix.scenario.name }} tests
        run: pytest -vv -s -m "${{ matrix.scenario.marker }}"
      
      # Debug information (only shown when debug mode is enabled)
      - name: Debug information
        if: runner.debug == '1'
        run: |
          echo "Scenario: ${{ matrix.scenario.name }}"
          echo "Marker: ${{ matrix.scenario.marker }}"
          pytest --markers
  
  test:
    name: Test on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    needs: lint
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.11', '3.12']
        
        # Exclude specific combinations to optimize CI time
        exclude:
          - os: macos-latest
            python-version: '3.9'
        
        # Include experimental Python versions
        include:
          - os: ubuntu-latest
            python-version: '3.13-dev'
            experimental: true
      
      # Don't fail all jobs if one fails
      fail-fast: false
    
    # Allow experimental jobs to fail without failing the workflow
    continue-on-error: ${{ matrix.experimental == true }}
    
    steps:
      # Checkout repository code - pinned to specific commit for security
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      # Setup Python with dependency caching
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Run tests with coverage and verbose output
      - name: Run tests with coverage
        run: pytest -vv --cov=calculator --cov-report=term-missing --cov-report=html
      
      # Upload coverage data as artifact (7-day retention)
      - name: Upload coverage artifact
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8  # v4.3.0
        with:
          name: coverage-report-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            .coverage
            htmlcov/
          retention-days: 7
      
      # Debug information (only shown when debug mode is enabled)
      - name: Debug information
        if: runner.debug == '1'
        run: |
          echo "Runner OS: ${{ runner.os }}"
          echo "Python version: ${{ matrix.python-version }}"
          echo "Matrix OS: ${{ matrix.os }}"
          python --version
          pip list
        shell: bash
  
  deploy:
    name: Deploy to Production
    needs: [lint, test]
    runs-on: ubuntu-latest
    # Only deploy on main branch pushes (not PRs) when all tests pass
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      success()
    
    # Use environment for deployment (allows environment protection rules)
    environment:
      name: production
      url: https://example.com
    
    steps:
      # Checkout repository code - pinned to specific commit for security
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      # Simulate deployment process
      - name: Simulate deployment
        run: |
          echo "ðŸš€ Deploying to production..."
          echo "Environment: Production"
          echo "Version: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit message: ${{ github.event.head_commit.message }}"
      
      # Debug information (only shown when debug mode is enabled)
      - name: Debug information
        if: runner.debug == '1'
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Repository: ${{ github.repository }}"
          env
  
  conditional-examples:
    name: Conditional Steps Examples
    runs-on: ubuntu-latest
    # This job demonstrates various conditional patterns
    if: always()  # Run even if previous jobs fail
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      # Pattern 3a: Run only on main branch
      - name: Run only on main branch
        if: github.ref == 'refs/heads/main'
        run: |
          echo "âœ… This step runs only on main branch"
          echo "Current branch: ${{ github.ref }}"
      
      # Pattern 3b: Run only on pull requests
      - name: Run only on pull requests
        if: github.event_name == 'pull_request'
        run: |
          echo "âœ… This step runs only on pull requests"
          echo "PR number: ${{ github.event.pull_request.number }}"
          echo "PR title: ${{ github.event.pull_request.title }}"
      
      # Pattern 3c: Run only on push events (not PRs)
      - name: Run only on push events
        if: github.event_name == 'push'
        run: |
          echo "âœ… This step runs only on push events"
          echo "Commit SHA: ${{ github.sha }}"
      
      # Pattern 3d: Intentional failure for demonstration
      - name: Step that might fail
        id: risky-step
        continue-on-error: true
        run: |
          echo "This step might fail..."
          # Uncomment the next line to see failure handling
          # exit 1
          echo "Step completed"
      
      # Pattern 3e: Run only if previous step failed
      - name: Run only on failure
        if: failure()
        run: |
          echo "âš ï¸ Previous step failed!"
          echo "This step runs only when a previous step fails"
      
      # Pattern 3f: Run only if previous step succeeded
      - name: Run only on success
        if: success()
        run: |
          echo "âœ… All previous steps succeeded!"
      
      # Pattern 3g: Always run (even on failure)
      - name: Always run cleanup
        if: always()
        run: |
          echo "ðŸ§¹ This step always runs, regardless of previous failures"
          echo "Job status: ${{ job.status }}"
      
      # Pattern 3h: Run only on specific conditions combined
      - name: Complex conditional
        if: |
          github.event_name == 'push' &&
          github.ref == 'refs/heads/main' &&
          success()
        run: |
          echo "âœ… This runs only on successful push to main"
      
      # Pattern 3i: Run based on file changes (requires checkout with fetch-depth: 0)
      - name: Check if Python files changed
        id: check-changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q '\.py$'; then
            echo "python_changed=true" >> $GITHUB_OUTPUT
          else
            echo "python_changed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Run only if Python files changed
        if: steps.check-changes.outputs.python_changed == 'true'
        run: echo "Python files were modified in this commit"
      
      # Pattern 3j: Run based on commit message
      - name: Check commit message
        if: contains(github.event.head_commit.message, '[skip ci]') == false
        run: echo "Commit does not contain [skip ci]"